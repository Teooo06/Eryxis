<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="stylesheet" th:href="@{/style/style.css}">
    <link rel="stylesheet" href="../static/style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
<header>
    <div class="title">
        <h1 class="nunito-1">eryxis</h1>
    </div>
    <div class="menu-section">
        <nav>
            <ul>
                <li class="selected">
                    <button class="menu-button">
                        <i class="fa fa-home spacing" aria-hidden="true"></i>
                        Overview
                    </button>
                </li>
                <li>
                    <form action="/trading">
                        <button class="menu-button">
                            <i class="fa fa-line-chart spacing" aria-hidden="true"></i>
                            Tradings
                        </button>
                    </form>
                </li>
                <li>
                    <form action="/setting">
                        <button class="menu-button">
                            <i class="fa fa-sliders spacing" aria-hidden="true"></i>
                            Settings
                        </button>
                    </form>
                </li>
                <li>
                    <form action="">
                        <button class="menu-button">
                            <i class="fa fa-comments spacing" aria-hidden="true"></i>
                            Support
                        </button>
                    </form>
                </li>
            </ul>
        </nav>
    </div>
    <div class="user-sec">
        <div class="user-name">
            <div class="user-image">
                <i class="fa fa-user fa-2x" aria-hidden="true"></i>
            </div>
            <h3 class="name" th:text="${nome + ' ' + cognome}"></h3>
        </div>
    </div>
</header>

<main>
    <section class="hero">
        <div class="saldo-sec">
            <div class="card-section">
                <!-- Right Section -->
                <div class="left-side">
                    <div class="card-list" th:each="carta : ${carte}">
                        <div class="card-part">
                            <h3 class="card-title">My Card</h3>
                            <div class="card">
                                <div class="ex-date">
                                    <h4 class="expire" th:text="${#strings.substring(carta.dataScadenza, 5, 7) + '/' + #strings.substring(carta.dataScadenza, 2, 4)}"></h4>
                                </div>
                                <div class="number-sec">
                                    <h2 class="number" th:text="${ '**** ' +
                                                               #strings.substring(carta.numeroCarta, 3 * carta.numeroCarta.length() / 4)}"></h2>

                                </div>
                                <div class="balance-sec">
                                    <div class="balance-text">
                                        <h6 class="caption-bal">Balance</h6>
                                        <h3 class="balance" th:text="${valuta + ' ' + carta.saldoDisponibile}" id="saldo-carta"></h3>
                                    </div>
                                    <div class="circuit">
                                        <img class="circuit-logo-visa" src="/images/visa.svg" alt="visa logo">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="indicators" th:if="${cardCount > 1}"></div>
                </div>
                <!-- Right Section -->
                <div class="right-side">
                    <div class="add-card">
                        <button class="card-plus-b" th:if="${cardCount < 3}" id="openBtn">
                            <i class="fa fa-plus-square" aria-hidden="true"></i> Add Card
                        </button>
                    </div>
                    <div class="transfer">
                        <form action="" class="form-b">
                            <button class="transfer-b">
                                <i class="fa fa-exchange fa-2x" style="padding-bottom: 10px" aria-hidden="true"></i> Transfers
                            </button>
                        </form>
                    </div>
                    <div class="transfer">
                        <form action="" class="form-b">
                            <button class="rubrica-b">
                                <i class="fa fa-address-book-o fa-2x" style="padding-bottom: 10px" aria-hidden="true"></i> Payee
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="transaction-sec">
                <div class="transaction-header">
                    <h2 class="transaction-text">Recent Transaction</h2>
                </div>
                <div class="transaction-list" th:each="transazione : ${transazioni}">
                    <div class="transaction-item">
                        <div class="transaction-icon">
                            <i class="fa fa-exchange fa-2x" style="padding-left: 27%; padding-top: 2%;" aria-hidden="true" th:if="${transazione.tipo == 'bonifico'}"></i>
                            <i class="fa fa-arrow-down fa-2x" style="padding-left: 30%; padding-top: 3%;" aria-hidden="true" th:if="${transazione.tipo == 'versamento'}"></i>
                            <i class="fa fa-arrow-up fa-2x" style="padding-left: 30%; padding-top: 3%;" aria-hidden="true" th:if="${transazione.tipo == 'prelievo'}"></i>
                        </div>
                        <div class="transaction-detail">
                            <h2 class="transaction-detail-text" th:text="${transazione.descrizione}"></h2>
                            <h3 class="transaction-date" th:text="${transazione.dataTransazione}"></h3>
                        </div>
                        <div class="transaction-value">
                            <h2 id="transactionImport" th:text="${transazione.importo + ' ' + valuta}"></h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="graph-sec">
            <div class="account-section">
                <div class="left-account">
                    <h4 class="account-pre-title">Your Total Balance</h4>
                    <h2 class="account-title" th:text="${valuta + ' ' + saldo}" id="saldo"></h2>
                    <div id="currentDateTime" class="date-box"></div>
                </div>
            </div>
            <div class="graph-title">
                <h2 class="title-gr">Monthly Movements</h2>
            </div>
            <div id="chart" class="graph">

            </div>
            <div class="legenda">
                <div class="legenda-side">
                    <div class="legenda-icon">
                        <i class="fa fa-arrow-up fa-3x" style="color: #D3D3D3" aria-hidden="true"></i>
                    </div>
                    <div class="legenda-text">
                        <h4 class="balance-leg">Balance</h4>
                        <h2 class="type-legenda" style="color: #D3D3D3">Income</h2>
                    </div>
                </div>
                <div class="legenda-side">
                    <div class="legenda-icon">
                        <i class="fa fa-arrow-down fa-3x" style="color: #660708" aria-hidden="true"></i>
                    </div>
                    <div class="legenda-text">
                        <h4 class="balance-leg">Balance</h4>
                        <h2 class="type-legenda" style="color: #660708">Outcome</h2>
                    </div>
                </div>
            </div>
        </div>
        <div id="popupOverlay" class="overlay" aria-hidden="true">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
                <button class="closeBtn" aria-label="Chiudi popup">&times;</button>
                <h2 id="modalTitle">Add Card</h2>
                <div class="card-adder">
                    <div class="first-card" th:if="${cardCount < 3 and not hasDebito}">
                        <form action="/addDebit" method="POST">
                            <button class="card-deb-b" type="submit">
                                <h2><i class="fa fa-credit-card"></i> Debit Card</h2>
                                <p>Acquista e attiva la tua carta di debito</p>
                                <span class="price" th:text="${valuta + '14,99'}"></span>
                            </button>
                        </form>
                    </div>

                    <div class="second-card">
                        <form action="/addPrepaid" method="POST">
                            <button class="card-ppd-b" th:if="${cardCount < 3 and not hasPrepagata}">
                                <h2><i class="fa fa-credit-card"></i> Prepaid Card</h2>
                                <p>Acquista e attiva la tua carta prepagata</p>
                                <span class="price" th:text="${valuta + '4,99'}"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
    const slides = document.querySelectorAll(".card-list .card-part");
    const indicatorsContainer = document.querySelector(".indicators");
    const slider = document.querySelector(".card-list");
    let currentIndex = 0;

    function createIndicators() {
        slides.forEach((_, index) => {
            const indicator = document.createElement("div");
            indicator.classList.add("indicator");
            if (index === 0) indicator.classList.add("active");
            indicator.addEventListener("click", () => changeSlide(index));
            indicatorsContainer.appendChild(indicator);
        });
    }

    function updateIndicators() {
        document.querySelectorAll(".indicator").forEach((dot, index) => {
            dot.classList.toggle("active", index === currentIndex);
        });
    }

    function changeSlide(index) {
        currentIndex = index;

        const card = slides[0];
        const cardWidth = card.offsetWidth;
        const offset = (cardWidth + 200) * index;

        slider.scrollTo({
            left: offset,
            behavior: 'smooth'
        });

        updateIndicators();
    }

    function autoChangeSlide() {
        currentIndex = (currentIndex + 1) % slides.length;
        changeSlide(currentIndex);
    }

    function prevSlide() {
        currentIndex = (currentIndex - 1 + slides.length) % slides.length;
        changeSlide(currentIndex);
    }

    function nextSlide() {
        currentIndex = (currentIndex + 1) % slides.length;
        changeSlide(currentIndex);
    }

    const cardCount = /*[[${cardCount}]]*/ 1; // fallback per sicurezza

    if (cardCount > 1) {
        createIndicators();
        changeSlide(0);
        setInterval(autoChangeSlide, 10000);
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
<script th:inline="javascript">
    const transazioni = /*[[${transazioni}]]*/ [];

    function formatDate(dataString) {
        const data = new Date(dataString);
        if (isNaN(data)) return 'Invalid Date';

        const giorno = String(data.getDate()).padStart(2, '0');
        const mesi = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const mese = mesi[data.getMonth()];
        return `${giorno} ${mese}`;
    }

    const incomeMap = {};
    const outcomeMap = {};

    transazioni.forEach(t => {
        const date = formatDate(t.dataTransazione);
        if (!incomeMap[date]) incomeMap[date] = 0;
        if (!outcomeMap[date]) outcomeMap[date] = 0;

        if (t.importo > 0) {
            incomeMap[date] += t.importo;
        } else {
            outcomeMap[date] += Math.abs(t.importo);
        }
    });

    const sortedDates = Object.keys({ ...incomeMap, ...outcomeMap }).sort((a, b) =>
        new Date('2025 ' + a) - new Date('2025 ' + b)
    );

    const incomeData = sortedDates.map(d => incomeMap[d] || 0);
    const outcomeData = sortedDates.map(d => outcomeMap[d] || 0);

    const chart = echarts.init(document.getElementById('chart'));

    const option = {
        tooltip: {
            trigger: 'axis',
            formatter: params =>
                params.map(p => `${p.seriesName}: $${p.value.toFixed(2)}`).join('<br/>')
        },
        xAxis: {
            type: 'category',
            data: sortedDates
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '${value}'
            }
        },
        series: [
            {
                name: 'Entrate',
                type: 'line',
                smooth: true,
                data: incomeData,
                lineStyle: { color: '#D3D3D3' },
                itemStyle: { color: '#D3D3D3' },
                areaStyle: { color: 'rgba(191,191,191,0.64)' }
            },
            {
                name: 'Uscite',
                type: 'line',
                smooth: true,
                data: outcomeData,
                lineStyle: { color: '#660708' },
                itemStyle: { color: '#660708' },
                areaStyle: { color: 'rgba(102, 7, 8, 0.1)' }
            }
        ]
    };

    chart.setOption(option);
</script>

<script>
    function updateDateTime() {
        const now = new Date();

        // Data in italiano → "giovedì 24 aprile 2025"
        const options = { day:'numeric', month:'long', year:'numeric' };
        let parts = new Intl.DateTimeFormat('it-IT', options).formatToParts(now);

        // Trova la parte 'month' e capitalizza solo la prima lettera
        parts = parts.map(p =>
            p.type === 'month'
                ? { ...p, value: p.value[0].toUpperCase() + p.value.slice(1) }
                : p
        );

        // Ricompone la data
        const dateStr = parts.map(p => p.value).join('');

        // Ora hh:mm:ss
        const timeStr = now.toLocaleTimeString('it-IT', {
            hour:'2-digit', minute:'2-digit'
        });

        document.getElementById('currentDateTime').textContent =
            `${dateStr} – ${timeStr}`;
    }

    updateDateTime();
    setInterval(updateDateTime, 1000);
</script>
<script>
    const openBtn   = document.getElementById('openBtn');
    const overlay   = document.getElementById('popupOverlay');
    const closeBtn  = overlay.querySelector('.closeBtn');

    // apre il popup
    openBtn.addEventListener('click', () => {
        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden', 'false');
    });

    // chiude quando si clicca sulla X
    closeBtn.addEventListener('click', closeModal);

    // chiude cliccando fuori dal riquadro
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeModal();
    });

    function closeModal() {
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
    }

    /* --- (facoltativo) chiusura con tasto Esc per accessibilità --- */
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('active')) closeModal();
    });
</script>
<script>
    // Funzione per formattare i numeri
    function formatNumber(number) {
        return new Intl.NumberFormat('it-IT', {
            maximumFractionDigits: 2,  // Puoi cambiare i decimali come preferisci
            minimumFractionDigits: 0   // Per evitare di mostrare decimali se il numero è intero
        }).format(number);
    }

    // Quando la pagina è completamente caricata
    window.onload = function() {
        // Formattare l'elemento con id 'saldo'
        let saldoElement = document.getElementById("saldo");
        if (saldoElement) {
            let saldoText = saldoElement.textContent.trim(); // Ottieni il testo (es. "€1500000000")
            let saldoNumber = parseFloat(saldoText.replace('€', '').replace(/,/g, '').trim()); // Rimuovi la valuta e formato
            saldoElement.textContent = "€" + formatNumber(saldoNumber); // Riformatta il numero
        }

        // Formattare tutti gli elementi con la classe 'saldo-carta'
        let saldoElements = document.querySelectorAll(".saldo-carta");
        saldoElements.forEach(function(element) {
            let saldoText = element.textContent.trim(); // Ottieni il testo (es. "€1500000000")
            let saldoNumber = parseFloat(saldoText.replace('€', '').replace(/,/g, '').trim()); // Rimuovi la valuta e formato
            element.textContent = "€" + formatNumber(saldoNumber); // Riformatta il numero
        });
    }
</script>
</body>
</html>